name: Deploy1

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    environment: Actions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Install Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.8.2'

      - name: Bump Version
        id: bump
        run: |
          set -e
          
          mvn -B -q build-helper:parse-version versions:set \
                -DnewVersion=\${parsedVersion.nextMajorVersion}.0.0 \
                -DprocessAllModules -DgenerateBackupPoms=false
          
          VER="$(mvn -q help:evaluate -Dexpression=project.version -DforceStdout)"
          echo "Nova Versao: $VER"
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build Project
        run: |
          mvn -B -q -DskipTests package

      - name: Copy Artifact
        run: |
          cp target/*.jar docker/app.jar

      - name: View Files
        run: |
          ls docker/

      - name: Build Docker
        run: |
          cd docker
          docker build . -t rodrigoloureiro/cervejaria-devops:${{ steps.bump.outputs.version }}

      - name: Commit POM
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "github bot ci: Bump para versÃ£o ${{ steps.bump.outputs.version }}"
          file_pattern: "pom.xml"

      - name: Docker TAG
        run: |
          docker tag rodrigoloureiro/cervejaria-devops:${{ steps.bump.outputs.version }} rodrigoloureiro/cervejaria-devops:latest

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: Docker Push Latest
        run: |
          docker push rodrigoloureiro/cervejaria-devops:latest

      - name: (Rascunho) Determinar o tipo de Version pela Label
        id: version-type
        run: |
          echo "Verificando labels do PR..."
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels -q ".labels[].name")
          VERSION_TYPE="patch"
          if echo "$LABELS" | grep -q 'version:major'; then VERSION_TYPE="major"; fi
          if echo "$LABELS" | grep -q 'version:minor'; then VERSION_TYPE="minor"; fi
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "$VERSION_TYPE"